name: Test

on:
  pull_request:
    branches:
      - main
    paths-ignore:
      - .github/workflows/**
      - '!.github/workflows/test.yml'
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

env:
  CARGO_TERM_COLOR: always
  NODE_VERSION: 22
  PNPM_VERSION: 10.13.1
  RUST_TOOLCHAIN: nightly-2025-12-04
  RUNNER_LABEL: &runner_label blacksmith-16vcpu-ubuntu-2404

jobs:
  frontend-checks:
    runs-on: *runner_label
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node
        uses: ./.github/actions/setup-node

      - name: Install dependencies
        run: pnpm install

      - name: Run frontend checks
        env:
          NODE_OPTIONS: --max-old-space-size=8192
        run: |
          npx concurrently \
            --kill-others-on-fail \
            --names "lint,i18n,fmt,build" \
            --timings \
            "cd frontend && npm run lint" \
            "GITHUB_BASE_REF=${{ github.base_ref || 'main' }} ./scripts/check-i18n.sh" \
            "cd frontend && npm run format:check" \
            "cd frontend && npm run build"

  backend-schema-checks:
    runs-on: *runner_label
    env:
      SCCACHE_GHA_ENABLED: "true"
      RUSTC_WRAPPER: "sccache"
    steps:
      - uses: actions/checkout@v6

      - name: Setup Rust
        uses: ./.github/actions/cargo-checks-common-setup
        with:
          toolchain: ${{ env.RUST_TOOLCHAIN }}
          cache-key: backend-schema-checks-${{ runner.os }}-${{ runner.arch }}-${{ env.RUNNER_LABEL }}
          setup-node: 'true'
          setup-sqlx-cli: 'true'

      - name: Check generated types
        run: npm run generate-types:check

      - name: Sqlx checks
        run: npm run prepare-db:check

  backend-remote-checks:
    if: ${{ github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository }}
    runs-on: *runner_label
    env:
      SCCACHE_GHA_ENABLED: "true"
      RUSTC_WRAPPER: "sccache"
    steps:
      - uses: actions/checkout@v6

      - name: Setup Rust
        uses: ./.github/actions/cargo-checks-common-setup
        with:
          toolchain: ${{ env.RUST_TOOLCHAIN }}
          cache-key: backend-remote-checks-${{ runner.os }}-${{ runner.arch }}-${{ env.RUNNER_LABEL }}
          setup-node: 'true'
          setup-sqlx-cli: 'true'

      - name: Setup SSH Agent for private dependencies
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VK_PRIVATE_DEPLOY_KEY }}

      - name: Check remote Cargo.lock is up to date
        run: |
          cargo generate-lockfile --manifest-path crates/remote/Cargo.toml
          git diff --exit-code crates/remote/Cargo.lock || (echo "::error::crates/remote/Cargo.lock is out of date. Run 'cargo generate-lockfile --manifest-path crates/remote/Cargo.toml' and commit the result." && exit 1)

      - name: Check generated types
        run: npm run remote:generate-types:check

      - name: Sqlx checks
        run: npm run remote:prepare-db:check

  backend-clippy:
    runs-on: *runner_label
    env:
      SCCACHE_GHA_ENABLED: "true"
      RUSTC_WRAPPER: "sccache"
    steps:
      - uses: actions/checkout@v6

      - name: Setup Rust
        uses: ./.github/actions/cargo-checks-common-setup
        with:
          toolchain: ${{ env.RUST_TOOLCHAIN }}
          components: rustfmt, clippy
          cache-key: backend-clippy-${{ runner.os }}-${{ runner.arch }}-${{ env.RUNNER_LABEL }}

      - name: Run Clippy and fmt checks
        run: |
          set -x
          cargo fmt --all -- --check & pid_fmt=$!
          cargo clippy --all --all-targets -- -D warnings
          wait $pid_fmt

  backend-test:
    runs-on: *runner_label
    env:
      SCCACHE_GHA_ENABLED: "true"
      RUSTC_WRAPPER: "sccache"
    steps:
      - uses: actions/checkout@v6

      - name: Setup Rust
        uses: ./.github/actions/cargo-checks-common-setup
        with:
          toolchain: ${{ env.RUST_TOOLCHAIN }}
          cache-key: backend-test-${{ runner.os }}-${{ runner.arch }}-${{ env.RUNNER_LABEL }}

      - name: Install cargo-nextest
        uses: taiki-e/install-action@nextest

      - name: Run Cargo tests
        run: cargo nextest run --workspace
